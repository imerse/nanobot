name: Sync Upstream

on:
  schedule:
    - cron: '0 3 * * 0'  # Weekly Sunday 3 AM
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/HKUDS/nanobot.git
          git fetch upstream
      
      - name: Check for updates
        id: check
        run: |
          LOCAL=$(git rev-parse HEAD)
          UPSTREAM=$(git rev-parse upstream/main)
          if [ "$LOCAL" != "$UPSTREAM" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi
        shell: bash
      
      - name: Merge upstream
        if: steps.check.outputs.has_updates == 'true'
        run: |
          git merge upstream/main --no-edit
      
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
      
      - name: Run tests
        run: |
          python -m pytest tests/ -v
      
      - name: Create Pull Request
        if: steps.check.outputs.has_updates == 'true'
        uses: actions/create-pull-request@v6
        with:
          title: 'Sync: upstream/main'
          body: |
            Automated sync with upstream repository
            - Merged latest changes from HKUDS/nanobot
            - All tests passed
          branch: sync/upstream
          delete-branch: true
